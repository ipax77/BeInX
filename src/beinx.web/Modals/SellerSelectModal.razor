@using Microsoft.JSInterop
@using beinx.shared
@using beinx.shared.Interfaces
@using beinx.web.Bases
@using beinx.web.Forms
@using pax.XRechnung.NET.AnnotatedDtos
@inherits DraftAwareComponentBase<SellerAnnotationDto, PartyEntity<SellerAnnotationDto>>
@inject ISellerRepository SellerRepository

<div class="modal" id="@modalId" aria-hidden="true" aria-labelledby="@modalId" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-fullscreen">
        <div class="modal-content">
            <div class="modal-body">
                @if (IsLoading)
                {
                    <p><em>Loading...</em></p>
                }
                else if (IsEditing)
                {
					<CascadingValue Value="EditContext" Name="partyEditContext">
						<SellerForm Party="@CurrentDraft.Data"
									Logo="@current?.Logo"
									OnValidSubmit="@SaveItemAsync"
									OnCodeListRequested="OnCodeListRequested"
									OnLogoChanged="LogoChanged"
									OnCancel="Close" />
					</CascadingValue>
                }
                else
                {
					<button class="btn btn-primary mb-3" @onclick="NewItem">@Loc["Add New Seller"]</button>

                    <select class="form-select" @bind="SelectedSellerId" @bind:after="SellerSelected">
                        <option value="">-- @Loc["SellerSelect"] --</option>
                        @foreach (var payment in Items)
                        {
                            <option value="@payment.Id">@payment.Party.Name</option>
                        }
                    </select>
                }
            </div>
        </div>
    </div>
</div>

@code {
	private string modalId = "sellerSelectModal";
	private PartyEntity<SellerAnnotationDto>? current => Items.FirstOrDefault(f => f.Id == CurrentDraft.EntityId);

	[Parameter, EditorRequired]
	public int? SelectedSellerId { get; set; }

	[Parameter]
	public EventCallback<CodeListRequest> OnCodeListRequested { get; set; }

	[Parameter]
	public EventCallback<PartyEntity<SellerAnnotationDto>> OnSellerSelected { get; set; }

	[Parameter]
	public EventCallback OnClose { get; set; }

	public void Show(int? selectedPaymentId)
	{
		SelectedSellerId = selectedPaymentId;
		if (SelectedSellerId.HasValue)
		{
			var seller = Items.FirstOrDefault(p => p.Id == SelectedSellerId.Value);
			if (seller != null)
			{
				EditItem(SelectedSellerId.Value, seller.Party);
			}
		}
		InvokeAsync(StateHasChanged);
		JSRuntime.InvokeVoidAsync("openModalById", modalId);
	}

	public void Close()
	{
		IsEditing = false;
		JSRuntime.InvokeVoidAsync("closeModalById", modalId);
		OnClose.InvokeAsync();
	}

	private async Task LogoChanged(DocumentReferenceAnnotationDto? newLogo)
	{
		if (current is not null)
		{
			current.Logo = newLogo;
			await SellerRepository.SetPartyLogo(current.Id ?? 0, newLogo);
			await InvokeAsync(StateHasChanged);
		}
	}

	protected override Task<List<PartyEntity<SellerAnnotationDto>>> GetAllAsync()
	=> SellerRepository.GetAllAsync();

	protected override Task<int> CreateAsync(SellerAnnotationDto dto)
		=> SellerRepository.CreateAsync(dto);

	protected override Task UpdateAsync(int id, SellerAnnotationDto dto)
		=> SellerRepository.UpdateAsync(id, dto);

	protected override Task DeleteAsync(int id)
		=> SellerRepository.DeleteAsync(id);

	protected override SellerAnnotationDto CreateNewDto()
		=> new();

	protected override async Task AfterCreatedAsync(int id, SellerAnnotationDto dto)
	{
		Items.Add(new PartyEntity<SellerAnnotationDto> { Id = id, Party = dto });
		await InvokeAsync(StateHasChanged);
		var existing = Items.FirstOrDefault(p => p.Id == id);
		await OnSellerSelected.InvokeAsync(existing);
		Close();
	}

	protected override int GetEntityId(PartyEntity<SellerAnnotationDto> entity) => entity.Id ?? 0;

	protected override async Task AfterUpdatedAsync(int id, SellerAnnotationDto dto)
	{
		var existing = Items.FirstOrDefault(p => p.Id == id);
		if (existing != null) existing.Party = dto;
		await InvokeAsync(StateHasChanged);
		await OnSellerSelected.InvokeAsync(existing);
		Close();
	}

	private void SellerSelected()
	{
		var existing = Items.FirstOrDefault(p => p.Id == SelectedSellerId);
		OnSellerSelected.InvokeAsync(existing);
		Close();
	}
}


