@using Microsoft.Extensions.Localization
@using Microsoft.Extensions.Logging
@using Microsoft.JSInterop
@using beinx.loc
@using beinx.shared
@using beinx.shared.Interfaces
@inject IIndexedDbInterop IndexedDbInterop
@inject IInvoiceService InvoiceService
@inject IInvoiceRepository InvoiceRepository
@inject IStringLocalizer<InvoiceLoc> Loc
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject ILogger<Dashboard> Logger

<div class="container-fluid mt-3">
	<div class="row">
		<!-- Header Section - Full width on mobile -->
		<div class="col-12 col-lg-4 mb-3">
			<div class="p-3 border rounded bgchart">
				<h3>Blazor eInvoice XRechung App</h3>
				<p class="text-muted">Manage and view your eInvoices effortlessly</p>
				<p class="small text-warning mt-3">
					Use of this application is subject to our <a href="https://github.com/ipax77/BeInX/blob/main/DISCLAIMER.md" target="_blank">Full Disclaimer</a>
					<span class="text-white-50">(external link)</span>
				</p>
			</div>
			<button class="btn btn-outline-light mt-1 mb-3 w-100 w-sm-auto" @onclick="@(e => NavigationManager.NavigateTo("invoice"))">@Loc["Create New Invoice"]</button>
			<div class="d-flex flex-column flex-sm-row align-items-stretch align-items-sm-end gap-2 gap-sm-3 my-3">
				<div class="flex-grow-1">
					<label for="yearInput" class="form-label">@Loc["Stats For Year"]</label>
					<input id="yearInput" type="number" class="form-control" step="1" @bind="year"
						   @bind:after="LoadStats" />
				</div>
				<div>
					<button type="button" class="btn btn-sm btn-outline-primary w-100 w-sm-auto" @onclick="LoadStats">@Loc["Refresh"]</button>
				</div>
			</div>
		</div>

		<!-- Stats Cards Section - Full width on mobile -->
		<div class="col-12 col-lg-7 mb-3">
			@if (statsResponse != null)
			{
				<!-- Stats Cards - Stack on mobile, row on larger screens -->
				<div class="row g-2 g-sm-3">
					<div class="col-12 col-sm-4">
						<div class="card">
							<div class="card-header bgchart2">
								@Loc["Total Invoices"]
							</div>
							<div class="card-body bgchart text-center">
								@statsResponse.TotalInvoices.ToString("N0")
							</div>
						</div>
					</div>
					<div class="col-12 col-sm-4">
						<div class="card">
							<div class="card-header bgchart2">
								@Loc["Paid"]
							</div>
							<div class="card-body bgchart text-center">
								@((statsResponse.TotalInvoices - statsResponse.UnpaidInvoices.Count).ToString("N0"))
							</div>
						</div>
					</div>
					<div class="col-12 col-sm-4">
						<div class="card">
							<div class="card-header bgchart2">
								@Loc["Unpaid"]
							</div>
							<div class="card-body bgchart text-center">
								@(statsResponse.UnpaidInvoices.Count.ToString("N0"))
							</div>
						</div>
					</div>
				</div>

				<!-- Unpaid Invoices Table -->
				<h5 class="mt-3">@Loc["Unpaid Invoices"]</h5>
				<div class="table-responsive border rounded p-2 mt-2" style="max-height: 400px;">
					<table class="table table-sm table-striped">
						<thead class="sticky-top bg-dark">
							<tr>
								<th class="text-nowrap">@Loc["Invoice ID"]</th>
								<th class="text-nowrap d-none d-md-table-cell">@Loc["Issue Date"]</th>
								<th class="text-nowrap d-none d-lg-table-cell">@Loc["Seller"]</th>
								<th class="text-nowrap d-none d-lg-table-cell">@Loc["Buyer"]</th>
								<th class="text-nowrap">@Loc["Amount"]</th>
								<th class="text-nowrap d-none d-sm-table-cell">@Loc["Paid?"]</th>
								<th class="text-nowrap">Actions</th>
							</tr>
						</thead>
						<tbody>
							@foreach (var inv in statsResponse.UnpaidInvoices)
							{
								<tr>
									<td>
										<span class="text-truncate d-inline-block" style="max-width: 100px">@inv.InvoiceId</span>
										<!-- Mobile: Show date below ID -->
										<small class="d-block d-md-none text-muted">@inv.IssueDate.ToShortDateString()</small>
									</td>
									<td class="d-none d-md-table-cell">@inv.IssueDate.ToShortDateString()</td>
									<td class="d-none d-lg-table-cell"><span class="text-truncate d-inline-block" style="max-width: 120px">@inv.SellerName</span></td>
									<td class="d-none d-lg-table-cell"><span class="text-truncate d-inline-block" style="max-width: 120px">@inv.BuyerName</span></td>
									<td class="text-nowrap">@inv.PayableAmount.ToString("N2")</td>
									<td class="d-none d-sm-table-cell">@(inv.IsPaid ? "✔️" : "❌")</td>
									<td>
										<!-- Mobile: Compact icon buttons in a horizontal group -->
										<div class="d-lg-none d-flex gap-1 flex-nowrap">
											<button class="btn btn-sm btn-outline-warning" title="@Loc["Edit"]"
													@onclick="() => EditItem(inv.Id)">
												<i class="bi bi-pencil"></i>
											</button>

											@if (inv.IsPaid)
											{
												<button class="btn btn-sm btn-outline-info" title="@Loc["Set Unpaid"]"
														@onclick="() => SetPaid(inv.Id, false)">
													<i class="bi bi-arrow-counterclockwise"></i>
												</button>
											}
											else
											{
												<button class="btn btn-sm btn-outline-success" title="@Loc["Set Paid"]"
														@onclick="() => SetPaid(inv.Id, true)">
													<i class="bi bi-check-lg"></i>
												</button>
											}

											<button class="btn btn-sm btn-outline-secondary" title="@Loc["Copy"]"
													@onclick="() => Copy(inv.Id)">
												<i class="bi bi-clipboard"></i>
											</button>

											<button class="btn btn-sm btn-outline-danger" title="@Loc["Delete"]"
													@onclick="() => DeleteItemAsync(inv.Id)">
												<i class="bi bi-trash"></i>
											</button>
										</div>
										<!-- Desktop: Full text buttons -->
										<div class="d-none d-lg-inline-flex gap-1 flex-wrap">
											<button class="btn btn-sm btn-outline-warning"
													@onclick="() => EditItem(inv.Id)">
												@Loc["Edit"]
											</button>
											@if (inv.IsPaid)
											{
												<button class="btn btn-sm btn-outline-info"
														@onclick="() => SetPaid(inv.Id, false)">
													@Loc["Set Unpaid"]
												</button>
											}
											else
											{
												<button class="btn btn-sm btn-outline-light"
														@onclick="() => SetPaid(inv.Id, true)">
													@Loc["Set Paid"]
												</button>
											}
											<button class="btn btn-sm btn-outline-secondary"
													@onclick="() => Copy(inv.Id)">
												@Loc["Copy"]
											</button>
											<button class="btn btn-sm btn-outline-danger"
													@onclick="() => DeleteItemAsync(inv.Id)">
												@Loc["Delete"]
											</button>
										</div>
									</td>
								</tr>
							}
						</tbody>
					</table>
				</div>
			}
		</div>
	</div>

	<!-- Stats Table and Chart Section -->
	<div class="row mt-2">
		<!-- Stats Table - Full width on mobile -->
		<div class="col-12 col-lg-4 mb-3">
			<div class="table-responsive">
				<table class="table table-striped">
					<thead class="table-light">
						<tr>
							<th>@Loc["Time Period"]</th>
							<th class="text-end">@Loc["Amount (tax inclusive)"]</th>
						</tr>
					</thead>
					@if (statsResponse != null)
					{
						<tbody>
							@foreach (var stat in statsResponse.Steps)
							{
								<tr>
									<td class="text-nowrap">@stat.Start.ToShortDateString() - @stat.End.ToShortDateString()</td>
									<td class="text-end text-nowrap">@stat.TotalAmountWithVat.ToString("N2")</td>
								</tr>
							}
						</tbody>
						<tfoot>
							<tr class="fw-bold">
								<td>@Loc["Total"]</td>
								<td class="text-end">
									@statsResponse.Steps.Sum(s => s.TotalAmountWithVat).ToString("N2")
								</td>
							</tr>
						</tfoot>
					}
				</table>
			</div>
		</div>

		<!-- Chart Section - Full width on mobile -->
		<div class="col-12 col-lg-7 mb-3">
			@if (statsResponse != null)
			{
				<StatsChartComponent @ref="statsChartComponent" StatsResponse="statsResponse" />
			}
		</div>
	</div>
</div>

@code {
	StatsResponse? statsResponse = null;
	List<Draft<object>> drafts = [];
	int year = DateTime.Now.Year;
	StatsChartComponent? statsChartComponent;

	protected override async Task OnInitializedAsync()
	{
		drafts = await IndexedDbInterop.GetAllDrafts();
		if (drafts.Count > 0)
		{
			NavigateToDraft(drafts[0]);
		}
		await LoadStats();
	}

	private async Task LoadStats()
	{
		statsResponse = await InvoiceService.GetStats(year);
		await InvokeAsync(StateHasChanged);
		statsChartComponent?.Update(statsResponse);
	}

	private void NavigateToDraft(Draft<object> draft)
	{
		Logger.LogWarning(draft.EntityType);
		switch (draft.EntityType)
		{
			case "PaymentMeans":
				NavigationManager.NavigateTo("payments");
				break;
			case "Buyers":
				NavigationManager.NavigateTo("buyers");
				break;
			case "Sellers":
				NavigationManager.NavigateTo("sellers");
				break;
			case "Invoices":
				NavigationManager.NavigateTo("invoice");
				break;
			default:
				break;
		}
	}

	private void EditItem(int id)
	{
		NavigationManager.NavigateTo($"invoice/{id}");
	}

	private async Task SetPaid(int id, bool isPaid)
	{
		var item = statsResponse?.UnpaidInvoices.FirstOrDefault(f => f.Id == id);
		if (item != null)
		{
			item.IsPaid = isPaid;
			await InvoiceRepository.SetPaidAsync(id, isPaid);

			// Refresh to maintain filter consistency
			await LoadStats();
		}
	}

	private async Task DeleteItemAsync(int id)
	{
		var item = statsResponse?.UnpaidInvoices.FirstOrDefault(f => f.Id == id);
		if (item is null)
		{
			return;
		}

		bool result = await JSRuntime.InvokeAsync<bool>("confirm", Loc["DeleteInvoice"].ToString());
		if (!result)
		{
			return;
		}

		await InvoiceRepository.DeleteAsync(id);

		// Reload data after deletion
		await LoadStats();
	}

	private async Task Copy(int id)
	{
		var item = statsResponse?.UnpaidInvoices.FirstOrDefault(f => f.Id == id);
		if (item is null)
		{
			return;
		}

		var entity = await InvoiceRepository.GetByIdAsync(id);
		if (entity is null)
		{
			return;
		}

		var invoiceDto = entity.Info.InvoiceDto;
		invoiceDto.Id = invoiceDto.Id + "_copy";
		invoiceDto.IssueDate = DateTime.UtcNow;
		invoiceDto.DueDate = DateTime.UtcNow.AddDays(14);
		invoiceDto.InvoiceLines.Clear();
		invoiceDto.AdditionalDocumentReferences.Clear();
		invoiceDto.PayableAmount = 0;

		await InvoiceRepository.CreateAsync(entity.Info);

		// Reload data after copying
		await LoadStats();
	}
}