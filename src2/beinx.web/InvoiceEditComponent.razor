@using BlazorInvoice.Pdf
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.Extensions.Logging
@using beinx.shared
@using beinx.shared.Interfaces
@using beinx.web.Bases
@using beinx.web.Forms
@using beinx.web.Modals
@using pax.BBToast
@using pax.XRechnung.NET.AnnotatedDtos
@inherits DraftAwareComponentBase<InvoiceDtoInfo, InvoiceEntity>
@inject IInvoiceRepository InvoiceRepository
@inject IToastService ToastService

<div class="container-fluid mt-2 mb-5">
	@if (IsLoading)
	{
		<p><em>Loading ...</em></p>
	}
	else
	{
		<div>
			<h2>@editOrCreateText</h2>
		</div>
		<div class="row">
			<div class="col-5">
				<hr />
				@if (!prerequisitesSatisfied)
				{
					<h6 class="text-uppercase text-muted fw-bold mb-3">
						@Loc["Prerequisites"]
					</h6>
				}
				<div>
					<EntitySelector DisplayName="@CurrentDraft.Data.InvoiceDto.SellerParty.Name"
									EntityId="CurrentDraft.Data.SellerId"
									SelectOrCreateLabel="@Loc["Select or Create Seller"]"
									EditLabel="@Loc["Edit Seller"]"
									DeleteLabel="@Loc["Delete"]"
									OnSelectOrCreate="() => sellerSelectModal?.Show(null)"
									OnEdit="(id) => sellerSelectModal?.Show(id)"
									OnDelete="HandleSellerDelete" />

					<EntitySelector DisplayName="@CurrentDraft.Data.InvoiceDto.BuyerParty.Name"
									EntityId="CurrentDraft.Data.BuyerId"
									SelectOrCreateLabel="@Loc["Select or Create Buyer"]"
									EditLabel="@Loc["Edit Buyer"]"
									DeleteLabel="@Loc["Delete"]"
									OnSelectOrCreate="() => buyerSelectModal?.Show(null)"
									OnEdit="(id) => buyerSelectModal?.Show(id)"
									OnDelete="HandleBuyerDelete" />

					<EntitySelector DisplayName="@CurrentDraft.Data.InvoiceDto.PaymentMeans.Name"
									EntityId="CurrentDraft.Data.PaymentId"
									SelectOrCreateLabel="@Loc["Select or Create Payment Means"]"
									EditLabel="@Loc["Edit Payment Means"]"
									DeleteLabel="@Loc["Delete"]"
									OnSelectOrCreate="() => paymentsSelectModal?.Show(null)"
									OnEdit="(id) => paymentsSelectModal?.Show(id)"
									OnDelete="HandlePaymentDelete" />
				</div>
				<hr />
				@if (prerequisitesSatisfied)
				{
					<CascadingValue Value="EditContext" Name="invoiceEditContext">
						<div>
							<InvoiceForm Invoice="@CurrentDraft.Data.InvoiceDto"
										 OnCodeListRequested="HandleCodeListRequest" />
						</div>
						<hr />
						<div>
							<InvoiceLinesSection Invoice="@CurrentDraft.Data.InvoiceDto"
												 OnCodeListRequested="HandleCodeListRequest"
												 OnInvoiceChanged="@(e => UpdateAsync(SelectedInvoiceId ?? 0, CurrentDraft.Data))" />
						</div>
					</CascadingValue>
				}
			</div>
			<div class="col-7">
				@if (prerequisitesSatisfied)
				{
					<div class="sticky-top mt-2">
						<div class="btn-group p-1 border rounded bg-dark-subtle">
							<button type="button" class="btn btn-outline-success"
									@onclick="Save">
								@Loc["Save"]
							</button>
						</div>

						<div class="mb-2">
							<button class="btn btn-outline-light" type="button" @onclick="e => ShowPdfComponent = !ShowPdfComponent">
								@if (ShowPdfComponent)
								{
									<i class="bi bi-chevron-double-up"></i>
									<span>Hide PDF</span>
								}
								else
								{
									<i class="bi bi-chevron-double-down"></i>
									<span>Show PDF</span>
								}
							</button>
						</div>
						@if (ShowPdfComponent)
						{
							<div class="mt-2 w-100">
								<InvoicePdfComponent @ref="invoicePdfComponent" Invoice="CurrentDraft.Data.InvoiceDto" />
							</div>
						}
					</div>
				}
			</div>
		</div>
		<PaymentsSelectModal @ref="paymentsSelectModal" SelectedPaymentId="CurrentDraft.Data.PaymentId"
							 OnCodeListRequested="HandleCodeListRequest"
							 OnPaymentSelected="OnPaymentSelected" />
		<SellerSelectModal @ref="sellerSelectModal" SelectedSellerId="CurrentDraft.Data.SellerId"
						   OnCodeListRequested="HandleCodeListRequest"
						   OnSellerSelected="OnSellerSelected" />
		<BuyerSelectModal @ref="buyerSelectModal" SelectedBuyerId="CurrentDraft.Data.BuyerId"
						  OnCodeListRequested="HandleCodeListRequest"
						  OnBuyerSelected="OnBuyerSelected" />
		<CodeListModal @ref="codeListModal" OnSelected="HandleCodeSelected" />
	}
</div>


@code {
	[Parameter, EditorRequired]
	public int? SelectedInvoiceId { get; set; }

	PaymentsSelectModal? paymentsSelectModal;
	SellerSelectModal? sellerSelectModal;
	BuyerSelectModal? buyerSelectModal;

	InvoicePdfComponent? invoicePdfComponent;

	private bool prerequisitesSatisfied => CurrentDraft.Data.PaymentId > 0
		&& CurrentDraft.Data.SellerId > 0
		&& CurrentDraft.Data.BuyerId > 0;

	private string editOrCreateText = string.Empty;

	private bool ShowPdfComponent = true;

	protected override async Task OnInitializedAsync()
	{
		if (SelectedInvoiceId.HasValue)
		{
			var entity = await InvoiceRepository.GetByIdAsync(SelectedInvoiceId.Value);
			if (entity != null)
			{
				EditItem(SelectedInvoiceId.Value, entity.Info);
			}
		}
		else
		{
			var dto = CreateNewDto();
			EditItem(0, dto);
		}
		await base.OnInitializedAsync();
		SelectedInvoiceId = CurrentDraft.EntityId;
		editOrCreateText = SelectedInvoiceId.HasValue ? Loc["Edit Invoice"] : Loc["Create New Invoice"];
	}

	private void OnPaymentSelected(PaymentMeansEntity args)
	{
		CurrentDraft.Data.PaymentId = args.Id ?? 0;
		CurrentDraft.Data.InvoiceDto.PaymentMeans = new PaymentAnnotationDto
		{
			Name = args.Payment.Name,
			Iban = args.Payment.Iban,
			Bic = args.Payment.Bic,
			PaymentMeansTypeCode = args.Payment.PaymentMeansTypeCode
		};
		StateHasChanged();
	}

	private void OnSellerSelected(PartyEntity<SellerAnnotationDto> args)
	{
		CurrentDraft.Data.SellerId = args.Id ?? 0;
		CurrentDraft.Data.InvoiceDto.SellerParty = args.Party;
		StateHasChanged();
	}

	private void OnBuyerSelected(PartyEntity<BuyerAnnotationDto> args)
	{
		CurrentDraft.Data.BuyerId = args.Id ?? 0;
		CurrentDraft.Data.InvoiceDto.BuyerParty = args.Party;
		StateHasChanged();
	}

	private void HandleSellerDelete()
	{
		CurrentDraft.Data.SellerId = 0;
		CurrentDraft.Data.InvoiceDto.SellerParty = new();
	}

	private void HandleBuyerDelete()
	{
		CurrentDraft.Data.BuyerId = 0;
		CurrentDraft.Data.InvoiceDto.BuyerParty = new();
	}

	private void HandlePaymentDelete()
	{
		CurrentDraft.Data.PaymentId = 0;
		CurrentDraft.Data.InvoiceDto.PaymentMeans = new();
	}

	private async Task Save()
	{
		try
		{
			if (SelectedInvoiceId.HasValue)
			{
				await UpdateAsync(SelectedInvoiceId.Value, CurrentDraft.Data);
			}
			else
			{
				var newId = await CreateAsync(CurrentDraft.Data);
				SelectedInvoiceId = newId;
			}
			ToastService.ShowSuccess(Loc["Invoice saved successfully."]);
		}
		catch (Exception ex)
		{
			ToastService.ShowError(Loc["An error occurred while saving the invoice: {0}", ex.Message]);
			return;
		}
	}

	protected override async Task SaveDraftAsync()
	{
		invoicePdfComponent?.Update(CurrentDraft.Data.InvoiceDto);
		await base.SaveDraftAsync();
	}

	protected override Task<List<InvoiceEntity>> GetAllAsync()
	{
		return Task.FromResult(new List<InvoiceEntity>());
	}

	protected override Task<int> CreateAsync(InvoiceDtoInfo dto)
		=> InvoiceRepository.CreateAsync(dto);

	protected override Task UpdateAsync(int id, InvoiceDtoInfo dto)
		=> InvoiceRepository.UpdateAsync(id, dto);

	protected override Task DeleteAsync(int id)
		=> InvoiceRepository.DeleteAsync(id);

	protected override InvoiceDtoInfo CreateNewDto()
	{
		// Initialize with minimal defaults; the InvoiceForm will handle editing
		return new InvoiceDtoInfo
		{
			InvoiceDto = new BlazorInvoiceDto
			{
				Id = Guid.NewGuid().ToString(),
				IssueDate = DateTime.Today,
				DueDate = DateTime.Today.AddDays(14),
				InvoiceTypeCode = "380",
				DocumentCurrencyCode = "EUR",
				GlobalTaxCategory = "S",
				GlobalTaxScheme = "VAT",
				GlobalTax = 0,
				PayableAmount = 0,
				PaymentTermsNote = "",
				SellerParty = new SellerAnnotationDto(),
				BuyerParty = new BuyerAnnotationDto(),
				PaymentMeans = new PaymentAnnotationDto(),
				InvoiceLines = []
			},
			SellerId = 0,
			BuyerId = 0,
			PaymentId = 0
		};
	}

	protected override int GetEntityId(InvoiceEntity entity) => entity.Id ?? 0;

	protected override async Task AfterCreatedAsync(int id, InvoiceDtoInfo dto)
	{
		Items.Add(new InvoiceEntity
		{
			Id = id,
			Info = dto,
			Year = dto.InvoiceDto.IssueDate.Year,
			IsPaid = false,
			IsImported = false,
			UpdatedAt = DateTime.UtcNow
		});
		await InvokeAsync(StateHasChanged);
	}

	protected override async Task AfterUpdatedAsync(int id, InvoiceDtoInfo dto)
	{
		var existing = Items.FirstOrDefault(i => i.Id == id);
		if (existing != null)
			existing.Info = dto;
		await InvokeAsync(StateHasChanged);
	}

}