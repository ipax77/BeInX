@using beinx.shared
@using beinx.shared.Interfaces
@using beinx.web.Bases
@using beinx.web.Forms
@using beinx.web.Modals
@using pax.XRechnung.NET.AnnotatedDtos
@inherits DraftAwareComponentBase<PaymentAnnotationDto, PaymentMeansEntity>
@inject IPaymentsRepository PaymentsRepository

<div class="container-fluid mt-2 mb-5">
    <h3>
        @Loc["Payment Means"]
    </h3>

    @if (IsLoading)
    {
        <p><em>Loading...</em></p>
    }
    else if (IsEditing)
    {
        <CascadingValue Value="EditContext" Name="paymentEditContext">
            <PaymentForm Payment="@CurrentDraft.Data"
                         OnValidSubmit="@SaveItemAsync"
                         OnCodeListRequested="HandleCodeListRequest"
                         OnCancel="@(() => IsEditing = false)" />
        </CascadingValue>
    }
    else
    {
        <button class="btn btn-primary mb-3" @onclick="NewItem">@Loc["Add New Payment Means"]</button>

        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Bank Name</th>
                    <th>IBAN</th>
                    <th>BIC</th>
                    <th>Type</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var p in Items)
                {
                    <tr>
                        <td>@p.Payment.Name</td>
                        <td>@p.Payment.Iban</td>
                        <td>@p.Payment.Bic</td>
                        <td>@p.Payment.PaymentMeansTypeCode</td>
                        <td>
                            @if (p.Id.HasValue)
                            {
                                <button class="btn btn-sm btn-outline-secondary me-1"
                                        @onclick="() => EditItem(p.Id.Value, p.Payment)">
                                    Edit
                                </button>
                                <button class="btn btn-sm btn-outline-danger"
                                        @onclick="() => DeleteItemAsync(p.Id.Value)">
                                    Delete
                                </button>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
    <CodeListModal @ref="codeListModal" OnSelected="HandleCodeSelected" />
</div>

@code {
    protected override Task<List<PaymentMeansEntity>> GetAllAsync()
        => PaymentsRepository.GetAllAsync();

    protected override Task<int> CreateAsync(PaymentAnnotationDto dto)
        => PaymentsRepository.CreateAsync(dto);

    protected override Task UpdateAsync(int id, PaymentAnnotationDto dto)
        => PaymentsRepository.UpdateAsync(new PaymentMeansEntity { Id = id, Payment = dto });

    protected override Task DeleteAsync(int id)
        => PaymentsRepository.DeleteAsync(id);

    protected override PaymentAnnotationDto CreateNewDto()
        => new();

    protected override int GetEntityId(PaymentMeansEntity entity) => entity.Id ?? 0;

    protected override async Task AfterCreatedAsync(int id, PaymentAnnotationDto dto)
    {
        Items.Add(new PaymentMeansEntity { Id = id, Payment = dto });
        await InvokeAsync(StateHasChanged);
    }

    protected override async Task AfterUpdatedAsync(int id, PaymentAnnotationDto dto)
    {
        var existing = Items.FirstOrDefault(p => p.Id == id);
        if (existing != null) existing.Payment = dto;
        await InvokeAsync(StateHasChanged);
    }
}